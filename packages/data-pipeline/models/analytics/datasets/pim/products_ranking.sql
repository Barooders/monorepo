{{ config(
    materialized='table',
    primary_key='id'
) }}

WITH

TRAFFIC30 AS (
  SELECT
    PRODUCTID,
    count(DISTINCT MP_INSERT_ID) AS NB_EVENTS

  FROM MIXPANEL_DIRECT_EXPORT.MP_MASTER_EVENT

  WHERE
    MP_EVENT_NAME = 'clickProduct'
    AND extract(DATE FROM TIME) >= date_sub(current_date(), INTERVAL 30 DAY)
    AND NOT (extract(DATE FROM TIME) = '2024-03-27')
  GROUP BY PRODUCTID
),

TRAFFIC7 AS (
  SELECT
    PRODUCTID,
    count(DISTINCT MP_INSERT_ID) AS NB_EVENTS

  FROM MIXPANEL_DIRECT_EXPORT.MP_MASTER_EVENT

  WHERE
    MP_EVENT_NAME = 'clickProduct'
    AND extract(DATE FROM TIME) >= date_sub(current_date(), INTERVAL 7 DAY)
    AND NOT (extract(DATE FROM TIME) = '2024-03-27')

  GROUP BY PRODUCTID
),

TRAFFICTOT AS (
  SELECT
    PRODUCTID,
    count(DISTINCT MP_INSERT_ID) AS NB_EVENTS

  FROM MIXPANEL_DIRECT_EXPORT.MP_MASTER_EVENT

  WHERE
    MP_EVENT_NAME = 'clickProduct'

  GROUP BY PRODUCTID
),

FAV AS (
  SELECT
    PRODUCTID,
    count(DISTINCT FAV.ID) AS NB_FAV

  FROM BAROODERS_BACKEND_PUBLIC.FAVORITEPRODUCTS AS FAV

  WHERE FAV.CREATEDAT >= date_sub(current_date(), INTERVAL 90 DAY)

  GROUP BY PRODUCTID
)

SELECT * FROM (
  SELECT
    PROD.ID,
    P.ID AS SHOPIFYID,
    CASE WHEN sum(TRAFFIC30.NB_EVENTS) IS NULL THEN 0 ELSE sum(TRAFFIC30.NB_EVENTS) END AS TRAFFIC30,
    CASE WHEN sum(TRAFFIC7.NB_EVENTS) IS NULL THEN 0 ELSE sum(TRAFFIC7.NB_EVENTS) END AS TRAFFIC7,
    CASE WHEN sum(TRAFFICTOT.NB_EVENTS) IS NULL THEN 0 ELSE sum(TRAFFICTOT.NB_EVENTS) END AS TRAFFICTOT,
    CASE WHEN sum(FAV.NB_FAV) IS NULL THEN 0 ELSE sum(FAV.NB_FAV) END AS NB_FAV

  FROM {{ ref('dim_product') }} AS P
  LEFT JOIN TRAFFIC30 AS TRAFFIC30 ON TRAFFIC30.PRODUCTID = cast(P.ID AS string)
  LEFT JOIN TRAFFIC7 AS TRAFFIC7 ON TRAFFIC7.PRODUCTID = cast(P.ID AS string)
  LEFT JOIN TRAFFICTOT AS TRAFFICTOT ON TRAFFICTOT.PRODUCTID = cast(P.ID AS string)
  LEFT JOIN FAV AS FAV ON cast(FAV.PRODUCTID AS string) = cast(P.ID AS string)
  LEFT JOIN BAROODERS_BACKEND_DBT.STORE_PRODUCT_FOR_ANALYTICS AS PROD ON P.ID = PROD.SHOPIFY_ID

  GROUP BY P.ID, PROD.ID
  ORDER BY NB_FAV DESC
)
WHERE ID IS NOT NULL AND TRAFFIC30 > 0
